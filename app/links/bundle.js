const isTouchDevice="d"in document.documentElement;window.gotoArticle=function(e){var t=CONZEPT_WEB_BASE+"/app/wikipedia/?t=&l="+window.getParameterByName("l")+"&qid="+e;window.parent.postMessage({event_id:"handleClick",data:{type:"link",title:"",url:t,current_pane:getCurrentPane(),target_pane:"ps2"}},"*")},keyboardJS.bind("alt+y",(function(e){window.parent.postMessage({event_id:"toggle-sidebar",data:{}},"*")}));const endpoint="https://"+window.getParameterByName("l")+".wikipedia.org/w/api.php",domParser=new DOMParser;function queryApi(e){const t=new URL(endpoint),n={format:"json",origin:"*",...e};return Object.keys(n).forEach((e=>t.searchParams.append(e,n[e]))),fetch(t).then((e=>e.json()))}const getPageTitle=e=>e.split("/").filter((e=>e)).pop();function getPageName(e){return queryApi({action:"query",titles:e,redirects:1}).then((e=>Object.values(e.query.pages)[0].title))}const isArticle=e=>!(e.endsWith(":")?e.slice(0,-1):e).includes(":");function getPageHtml(e){return queryApi({action:"parse",page:e,prop:"text",redirects:1}).then((e=>e.parse.text["*"]))}function getFirstParagraph(e){return r=Array.from(e.querySelectorAll("p:not(.mw-empty-elt)")).find((e=>!e.querySelector("#coordinates"))),r}function getWikiLinks(e){var t=$(e),n=[];return $("p a, li a",t).each((function(e,t){return $(this).parents().is("table")?0:(t=$(this).attr("href")||"",$(this).hasClass("mw-redirect")?0:void(t.startsWith("/wiki/")&&(t.startsWith("/wiki/Special:")||t.startsWith("/wiki/Template:")||t.startsWith("/wiki/Template_talk:")||t.startsWith("/wiki/File:")||t.startsWith("/wiki/File_talk:")||t.startsWith("/wiki/Help:")||t.startsWith("/wiki/Help_talk:")||t.startsWith("/wiki/Wikipedia:")||t.startsWith("/wiki/Wikipedia_talk:")||t.startsWith("/wiki/User:")||t.startsWith("/wiki/User_talk:")||t.includes("(identifier)")||(t=(t=(t=t.split("/").filter((e=>e)).pop()).split("#")[0]).replace(/_/g," "),n.push(t)))))})),n=n.filter(((e,t,n)=>n.indexOf(e)===t)).filter(((e,t)=>t<18))}function getSubPages(e){return getPageHtml(e).then(getWikiLinks)}function getRandomArticle(){return queryApi({action:"query",list:"random",rnlimit:1,rnnamespace:0}).then((e=>e.query.random[0].title))}function getSuggestions(e){return queryApi({action:"opensearch",search:e,limit:10,namespace:0}).then((e=>e[1]))}var api_endpoint="https://wikipedia-map.now.sh/";function requestPage(e,t){t=t||function(){};var n=new XMLHttpRequest;n.onreadystatechange=function(){4==n.readyState&&200==n.status&&t(n.responseText)},n.open("GET",e,!0),n.send()}function getJSON(e,t){requestPage("http://luke.deentaylor.com/wikipedia/graphs/"+e,t)}function maxLevel(){const e=nodes.getIds().map((e=>nodes.get(e).level));return Math.max.apply(null,e)}function hexToRGB(e){e.startsWith("#")&&(e=e.slice(1,e.length));return[e.slice(0,2),e.slice(2,4),e.slice(4,6)].map((e=>parseInt(e,16)))}function rgbToHex(e){return`#${e.map((e=>Math.round(e).toString(16))).map((e=>1===e.length?`0${e}`:e)).join("")}`}function lightenHex(e,t){return rgbToHex(hexToRGB(e).map((e=>e+Math.min(t,100)/100*(255-e))))}function getColor(e){return lightenHex("#03A9F4",5*e)}function getYellowColor(e){return lightenHex("#FFC107",5*e)}function getEdgeColor(e){const t=getColor(e);return vis.util.parseColor(t).border}function wordwrap(e,t){const n=e.split(" "),o=[n[0]];return n.slice(1).forEach((e=>{o[o.length-1].length+e.length>t?o.push(e):o[o.length-1]+=` ${e}`})),o.join("\n")}function unwrap(e){return e.replace(/\n/g," ")}function getNeutralId(e){return e}function sign(e){return 0===e?0:e>0?1:-1}function colorNodes(e,t){const n=t?getYellowColor:getColor;for(let t=0;t<e.length;t+=1)e[t].color=n(e[t].level),delete e[t].x,delete e[t].y;nodes.update(e),isReset=!1}function edgesWidth(e,t){for(let n=0;n<e.length;n+=1)e[n].width=t;edges.update(e),isReset=!1}function getEdgeConnecting(e,t){const n=edges.get({filter:n=>n.from===e&&n.to===t})[0];return(n instanceof Object?n:{}).id}function getCenter(){const e=network.getPositions(),t=Object.keys(e);let n=0,o=0;return Object.values(e).forEach((e=>{n+=e.x,o+=e.y})),[n/t.length,o/t.length]}function getSpawnPosition(e){const{x:t,y:n}=network.getPositions(e)[e],o=getCenter(),a=o[0]-t,i=o[1]-n;let s,r;if(0===a)s=0,r=100*-sign(i);else{const e=i/a;s=200/Math.sqrt(e**2+1),r=s*e}return[Math.round(s+t),Math.round(r+n)]}function expandNodeCallback(e,t){const n=nodes.get(e).level+1,o=t,a=[],i=[],[s,r]=getSpawnPosition(e);for(let t=0;t<o.length;t+=1){const d=o[t],l=getNeutralId(d);-1===nodes.getIds().indexOf(l)&&a.push({id:l,label:wordwrap(decodeURIComponent(d),15),value:1,level:n,color:getColor(n),parent:e,x:s,y:r}),getEdgeConnecting(e,l)||i.push({from:e,to:l,color:getEdgeColor(n),level:n,selectionWidth:2,hoverWidth:5})}nodes.add(a),edges.add(i)}function expandNode(e){if(e=e.replace("%3A",":"),valid(nodes._data[e])){const t=nodes.get(e).label,n=unwrap(t);console.log("label: ",t),console.log("pagename: ",n),getSubPages(n).then((t=>expandNodeCallback(e,t)))}else console.log("warning: ",e,nodes.get(e),nodes),getSubPages(unwrap(e)).then((t=>expandNodeCallback(decodeURIComponent(e),t)))}function getTraceBackNodes(e){let t=e,n=!1;const o=[];for(;!n;)o.push(t),-1!==startpages.indexOf(t)&&(n=!0),t=nodes.get(t).parent;return o}function getTraceBackEdges(e){e.reverse();const t=[];for(let n=0;n<e.length-1;n+=1)t.push(getEdgeConnecting(e[n],e[n+1]));return t}function resetProperties(){if(!isReset){window.selectedNode=null;colorNodes(window.tracenodes.map((e=>nodes.get(e))),0);edgesWidth(window.traceedges.map((e=>{const t=edges.get(e);return t.color=getEdgeColor(nodes.get(t.to).level),t})),1),window.tracenodes=[],window.traceedges=[]}}function traceBack(e){if(e!==window.selectedNode){window.selectedNode=e,resetProperties(),window.tracenodes=getTraceBackNodes(e),window.traceedges=getTraceBackEdges(window.tracenodes);colorNodes(window.tracenodes.map((e=>nodes.get(e))),1);edgesWidth(window.traceedges.map((e=>{const t=edges.get(e);return t.color={inherit:"to"},t})),5)}}let nodes,edges,network;window.isReset=!0,window.selectedNode=null,window.traceedges=[],window.tracenodes=[];let startpages=[],needsreset=!0,darkmode=$("body").hasClass("dark"),font_color=darkmode?"white":"#121212",bg_color=darkmode?"#121212":"#fbfaf942";const container=document.getElementById("container"),options={nodes:{shape:"dot",scaling:{min:20,max:30,label:{min:14,max:25,drawThreshold:9,maxVisible:100}},font:{size:14,color:font_color,face:"sans",background:bg_color}},interaction:{hover:!0,hoverConnectedEdges:!1,selectConnectedEdges:!0}};nodes=new vis.DataSet,edges=new vis.DataSet;let data={nodes:nodes,edges:edges},initialized=!1;function makeNetwork(){network=new vis.Network(container,data,options),bindNetwork(),initialized=!0}function resetNetwork(e){initialized||makeNetwork();const t=getNeutralId(e);startpages=[t],window.tracenodes=[],window.traceedges=[],nodes=new vis.DataSet([{id:t,label:wordwrap(decodeURIComponent(e),20),value:2,level:0,color:getColor(0),x:0,y:0,parent:t}]),edges=new vis.DataSet,data={nodes:nodes,edges:edges},network.setData(data),firstAction&&tags.forEach((e=>{expandNode(encodeURIComponent(e)),firstAction=!1}))}function addStart(e,t){if(needsreset)resetNetwork(e),needsreset=!1;else{const t=getNeutralId(e);startpages.push(t),nodes.add([{id:t,label:wordwrap(decodeURIComponent(e),20),value:2,level:0,color:getColor(0),x:0,y:0,parent:t}])}}function resetNetworkFromInput(){needsreset=!0;const e=getItems(document.getElementsByClassName("commafield")[0]);e[0]?e.forEach((e=>getPageName(encodeURI(e)).then(addStart))):noInputDetected()}function randomReset(){needsreset=!0;const e=document.getElementsByClassName("commafield")[0];clearItems(e);const t=()=>{getRandomArticle().then((t=>{addStart(t),addItem(e,decodeURIComponent(t))}))};if(Math.random()<.3)for(let e=0;e<=Math.ceil(2*Math.random());e+=1)try{setTimeout(t,1e3*e)}catch(e){}else t()}function resetNetworkFromJson(e){initialized||makeNetwork();const t=networkFromJson(e);nodes=t.nodes,edges=t.edges,startpages=t.startpages,network.setData({nodes:nodes,edges:edges}),startpages.forEach((e=>{addItem(document.getElementById("input"),nodes.get(e).label)}))}function getFloatingEdges(){const e=[];return edges.forEach((t=>{nodes.get(t.to).parent!==t.from&&e.push(t)})),e}function abbreviateNode(e){return{a:e.label,b:e.level,c:e.parent}}function abbreviateEdge(e){return{a:e.from,b:e.to,c:e.level}}function networkToJson(){const e={},t=nodes._data,n=Object.keys(t).map((e=>t[e])).map(abbreviateNode);return e.nodes=n,e.startpages=startpages,e.edges=getFloatingEdges(),JSON.stringify(e)}function unabbreviateNode(e,t){const n={label:e.a,level:e.b,parent:e.c};return n.id=getNeutralId(n.label),n.color=getColor(n.level),n.value=-1===t.indexOf(n.id)?1:2,n}function unabbreviateEdge(e){const t={from:e.a,to:e.b,level:e.c};return t.color=getEdgeColor(t.level),t.selectionWidth=2,t.hoverWidth=0,t}function buildEdges(e){const t=new vis.DataSet;return e.forEach((e=>{e.parent!==e.id&&t.add({from:e.parent,to:e.id,color:getEdgeColor(e.level),level:e.level,selectionWidth:2,hoverWidth:0})})),t}function networkFromJson(e){const t=JSON.parse(e),n={};n.startpages=t.startpages;const o=t.nodes.map((e=>unabbreviateNode(e,n.startpages)));return n.nodes=new vis.DataSet,n.nodes.add(o),n.edges=buildEdges(o),n.edges.add(t.edges),n}function loadGraph(e){getJSON(e,resetNetworkFromJson)}function howConcise(){const e=JSON.stringify(nodes._data).length+JSON.stringify(edges._data).length+JSON.stringify(startpages).length,t=networkToJson().length,n=e-t,o=n/e*100,a=t/nodes.length;console.log(`Abbreviation takes JSON size from ${e} bytes (unabbreviated) to ${t} bytes (abbreviated)`),console.log(`Saves a total of ${n} bytes (${o} percent)`),console.log(`Average size of ${a} bytes per node`)}let firstAction=!0;function expandEvent(e){if(e.edges.length>0){let a=network.getConnectedNodes(e.edges[0]);if(window.location!==window.parent.location){o=(o=a[0]).replace(/\{\}/g,"");var t=a[1].replace(/ /g,"_"),n=CONZEPT_WEB_BASE+"/app/wikipedia/?t="+o+"&l="+window.getParameterByName("l")+"&qid=";window.postMessage({event_id:"handleClick",data:{type:"link",title:o,url:n,current_pane:getCurrentPane(),target_pane:"ps2",ids:t}},"*")}firstAction=!1}if(e.nodes.length){const t=e.nodes[0];if(expandNode(t),firstAction=!1,window.location!==window.parent.location){var o=t||"";if(firstAction&&encodeURIComponent(getParameterByName("t"))===o);else{o=o.replace(/\{\}/g,"");n=CONZEPT_WEB_BASE+"/app/wikipedia/?t="+o+"&l="+window.getParameterByName("l")+"&qid=";window.parent.postMessage({event_id:"handleClick",data:{type:"link",title:o,url:n,current_pane:getCurrentPane(),target_pane:getTargetPane(),ids:""}},"*")}}}}function mobileTraceEvent(e){if(e.nodes.length){traceBack(e.nodes[0])}else resetProperties()}function openPageEvent(e){if(e.nodes.length){const t=e.nodes[0],n=`http://en.wikipedia.org/wiki/${encodeURIComponent(unwrap(nodes.get(t).label))}`;window.open(n,"_blank")}}function bindNetwork(){isTouchDevice?(network.on("hold",expandEvent),network.on("click",mobileTraceEvent)):(network.on("click",expandEvent),network.on("hoverNode",(e=>traceBack(e.node))),network.on("blurNode",resetProperties))}function bind(){document.addEventListener("touchmove",(e=>e.preventDefault()));document.querySelector(".commafield");document.getElementById("submit").addEventListener("click",(()=>{resetNetworkFromInput()}));document.getElementById("random").addEventListener("click",randomReset)}function removeThis(){this.parentElement.removeChild(this)}function onPlaceholder(e){if(e.hasAttribute("data-placeholder")){e.getElementsByTagName("input")[0].setAttribute("placeholder",e.getAttribute("data-placeholder"))}}function offPlaceholder(e){if(e.hasAttribute("data-placeholder")){e.getElementsByTagName("input")[0].removeAttribute("placeholder")}}function getRegisteredItems(e){const t="string"==typeof e?document.getElementById(e):e;return Array.from(t.getElementsByClassName("item")).map((e=>e.textContent))}function getItems(e){const t=getRegisteredItems(e),n="string"==typeof e?document.getElementById(e):e;return n.getElementsByTagName("input")[0].value.trim().length&&t.push(n.getElementsByTagName("input")[0].value),t}function addItem(e,t){const n=document.createElement("div"),o=document.createTextNode(t);n.appendChild(o),n.className="item",n.onclick=removeThis,e.insertBefore(n,e.getElementsByTagName("input")[0]),offPlaceholder(e)}function removeLast(e){const t=e.getElementsByClassName("item");t.length&&e.removeChild(t[t.length-1]),getRegisteredItems(e).length||onPlaceholder(e)}function clearItems(e){for(e.getElementsByTagName("input")[0].value="";e.getElementsByClassName("item").length;)removeLast(e)}function cfKeyDown(e=window.event){const t=e.which||e.keyCode,n=e.target;switch(t){case 188:if(e.altKey){e.preventDefault(),n.value+=",";break}case 13:case 9:e.preventDefault(),n.value.trim().length&&-1===getRegisteredItems(this).indexOf(n.value)&&(addItem(this,n.value.trim()),n.value="");break;case 8:""===n.value&&removeLast(this)}}const cfs=Array.from(document.getElementsByClassName("commafield"));cfs.forEach((e=>{e.innerHTML='<input class="cfinput" type="text"/>',onPlaceholder(e),e.onkeydown=cfKeyDown}));var tags=[];function loadSaved(){if(window.location.search){window.language=getParameterByName("l")||"en",tags=getParameterByName("t")||"";let e=[],t=getParameterByName("q")||"";if(t=t.split(","),t.length>0&&valid(t[0])){tags="";fetchLabel(t,window.language).then((function(n){let o="";Object.values(n.entities).forEach((n=>{if(valid(n.labels[window.language])){o=n.labels[window.language].value;let a=[];$.each(t,(function(t,n){a.push($.ajax({url:"https://www.wikidata.org/wiki/Special:EntityData/"+n+".json",jsonp:"callback",dataType:"json",success:function(t){if(valid(t.entities[n].sitelinks[window.language+"wiki"])){const o=t.entities[n].sitelinks[window.language+"wiki"].title;e.push(o)}}}))})),$.when.apply($,a).then((function(){tags=e.join(","),doRender()}))}else console.log("warning: no label found for Qids: ",t)}))}))}else doRender()}}function doRender(){tags=tags.split(","),$.each(tags,(function(e,t){addItem(document.getElementById("input"),decodeURIComponent(t))})),$("#submit").trigger("click")}function Modal(e,t){this.clickToDismiss=void 0===t||t,this.elem=document.createElement("div"),"string"==typeof e?this.elem.innerHTML=e:this.elem.appendChild(e),this.elem.className="centered",this.backdrop=document.createElement("div"),this.backdrop.className="modal-background transparent-blur",this.backdrop.appendChild(this.elem),this.backdrop.parent=this,this.backdrop.addEventListener("click",(e=>{-1!==e.target.className.indexOf("modal-background")&&this.parent.clickToDismiss&&this.parent.close()})),this.present=()=>{document.body.appendChild(this.backdrop)},this.close=()=>{document.body.removeChild(this.backdrop)}}function Progress(e="",t="",n=""){this.container=document.createElement("div"),this.elem=document.createElement("div"),this.elem.className=`${t} progressbar`,this.bar=document.createElement("div"),this.bar.className=`${n} progressbar-indicator`,this.title=document.createElement("h1"),this.title.textContent=e,this.label=document.createElement("div"),this.label.className="progressbar-label",this.label.textContent="0",this.elem.appendChild(this.bar),this.container.appendChild(this.title),this.container.appendChild(this.elem),this.container.appendChild(this.label),this.bar.style.width="0px",this.progress=e=>void 0!==e?(this.bar.style.width=100*e+"%",this.label.textContent=Math.floor(100*e),e):this.bar.offsetWidth/this.elem.offsetWidth}
