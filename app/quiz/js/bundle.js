"use strict";const app={};function changeQS(e,a){let t=new URLSearchParams(location.search.substr(1));t.set(e,a),location.search=t.toString()}function init(){$("#country-form").select2(),$("#country-form").on("change",(function(){console.log(this.value);for(const[e,a]of Object.entries(countries))this.value===a.iso2&&(console.log(e,this.value),app.country=e,app.country_label=a.name,changeQS("country",app.country))})),app.round=1,newQuiz(),"location"===app.mode?mapInitialize():"list"===app.mode?selectInitialize():"gallery"===app.mode&&galleryInitialize(),$("#submit").click((function(){doGuess(),newInput()})),$("#result").on("click",".closeBtn",(function(){$("#result").fadeOut(500),app.round++,document.body.style.background='url("")',newQuiz(),"location"===app.mode&&(app.guess.setLatLng({lat:0,lng:0}),app.mymap.setView([20,20],1))}))}function getWikipediaHtml(e){let a=e.replace(/%20/,"_");console.log(a);let t="https://"+language+".wikipedia.org/w/api.php?action=parse&page="+encodeURIComponent(a)+"&prop=text&format=json";$.ajax({url:t,jsonp:"callback",dataType:"jsonp",success:function(e){console.log(e)}})}function newQuiz(){app.qid=getParameterByName("q"),app.qid1=getParameterByName("q1"),app.pid=getParameterByName("p"),app.pid1=getParameterByName("p1"),app.mode=getParameterByName("m"),app.language=getParameterByName("l"),app.only_label=getParameterByName("o"),app.depth_query=getParameterByName("d"),app.tree_depth=getParameterByName("n"),app.country=getParameterByName("country"),app.country_label="",""!==app.country&&(void 0===typeof countries[app.country]||void 0===countries[app.country]||(app.country_label=countries[app.country].name)),app.pid_type="",app.pid_label="",app.thumbnail_size="1400",app.random_spaces=" ".repeat(Math.floor(100*Math.random())),""===app.mode&&(app.mode="location"),app.qid&&app.pid1&&app.qid1||""===app.pid&&(app.pid="P625"),""===app.only_label?app.only_label=!1:app.only_label=!0,""===app.depth_query?app.depth_query=!1:app.depth_query=!0,""===app.tree_depth&&(app.tree_depth=1),""===app.language&&(app.language="en"),$("#loading").show();let e="https://www.wikidata.org/wiki/Special:EntityData/"+app.qid+".json";$.ajax({url:e,dataType:"json",success:function(e){app.qid_label=e.entities[app.qid].labels[app.language].value.toLowerCase()||"",getProperties()}})}function getProperties(){if(app.only_label)if("en"===app.language)app.pid_label="name",getPropertyName();else{let e="https://www.wikidata.org/wiki/Special:EntityData/Q82799.json";$.ajax({url:e,dataType:"json",success:function(e){app.pid_label=e.entities.Q82799.labels[app.language].value.toLowerCase(),getPropertyName()}})}else getPropertyName()}function getPropertyName(){let e="",a="",t="";console.log(app.qid1,app.pid1),app.qid&&app.pid1&&app.qid1?(console.log("double query"),e=" wdt:P31 wd:"+app.qid+" ; wdt:"+app.pid1+" wd:"+app.qid1+" . ",a=" wdt:P31 wd:"+app.qid+" . ",t="https://www.wikidata.org/wiki/Special:EntityData/"+app.pid1+".json"):app.qid?(e=" wdt:P31 wd:"+app.qid+" . ",t="https://www.wikidata.org/wiki/Special:EntityData/"+app.pid+".json"):(e="",t="https://www.wikidata.org/wiki/Special:EntityData/"+app.pid+".json"),$.ajax({url:t,dataType:"json",success:function(t){if(app.only_label||(app.qid&&app.pid1&&app.qid1?(app.pid_type=t.entities[app.pid1].datatype,app.pid_label=t.entities[app.pid1].labels[app.language].value.toLowerCase(),"commonsMedia"===app.pid_type&&(app.pid_type=t.entities[app.pid1].labels.en.value),console.log("--- data type: ",app.pid_type)):(app.pid_type=t.entities[app.pid].datatype,app.pid_label=t.entities[app.pid].labels[app.language].value.toLowerCase())),console.log(app.pid_type,app.pid_label),"location"===app.mode?locationQuery(e):"list"===app.mode?listQuery(e):"gallery"===app.mode&&galleryQuery(e,a),"gallery"===app.mode){let e="https://www.wikidata.org/wiki/Special:EntityData/"+app.qid1+".json";$.ajax({url:e,dataType:"json",success:function(e){let a=e.entities[app.qid1].labels[app.language].value.toLowerCase()||"";$("#title").text(app.qid_label+" : "+app.pid_label+" : "+a+(""===app.country_label?"":" : "+app.country_label))}})}else $("#title").text(app.qid_label+" : "+app.pid_label+(""===app.country_label?"":" : "+app.country_label))}})}function galleryQuery(e,a){let t=9;"string"===app.pid_type&&(t=10);let i=`\n    SELECT ?item ?itemLabel ?itemDescription ?prop ?photo WHERE { \n        { \n            SELECT ?item ?photo ?prop\n            WHERE { \n                ?item wdt:P18 ?photo ;          \n                ${a}\n            } ORDER BY STRUUID() ${app.random_spaces} LIMIT ${t}\n        } \n        SERVICE wikibase:label { bd:serviceParam wikibase:language "${app.language},en". } \n    } \n    `,o=`\n    SELECT ?item ?itemLabel ?itemDescription ?prop ?photo WHERE { \n        { \n            SELECT ?item ?photo ?prop\n            WHERE { \n                ?item wdt:P18 ?photo ;          \n                ${e}\n            } ORDER BY STRUUID() ${app.random_spaces} LIMIT ${t}\n        } \n        SERVICE wikibase:label { bd:serviceParam wikibase:language "${app.language},en". } \n    } \n    `;const p="https://query.wikidata.org/bigdata/namespace/wdq/sparql?format=json&query="+i,n="https://query.wikidata.org/bigdata/namespace/wdq/sparql?format=json&query="+o;console.log(o),window.fetch(p).then((function(e){window.fetch(n).then((function(a){createGallery(e,a)})).catch((function(e){console.warn("Fetch Error :-S",e)}))})).catch((function(e){console.warn("Fetch Error :-S",e)}))}function createGallery(e,a){e.json().then((function(e){a.json().then((function(a){let t=Math.floor(Math.random()*e.results.bindings.length),i=e.results.bindings[t];$("body").css("background-image","none"),$("#loading").hide(),$("body").css("background","black"),window.locID=i.item.value,app.qid=i.item.value.replace(/http:\/\/www.wikidata.org\/entity\//,""),window.itemName=i.itemLabel.value,console.log(app.pid);window.itemPropsObj={};console.log(i);let o="";console.log(a.results.bindings.length);let p=a.results.bindings[0],n=p.photo.value.replace(/http:/,"https:")+"?width=300px",l=p.itemLabel.value||"",s="";void 0===typeof p.itemDescription||void 0===p.itemDescription||(s=p.itemDescription.value||"");let r=p.item.value.replace(/http:\/\/www.wikidata.org\/entity\//,"").split("-").shift(),c='<figure class="'+r+'"><img src="'+n+'" alt="-" width="300" height="100%"><figcaption><a href="javascript:void(0)" onclick="revealGalleryDetails(&quot;'+r+'&quot;)"><i class="fas fa-check-circle fa-3x"></i></a><span id="'+r+'" class="gallery-image-details correct" style="visibility:hidden;"></a>&nbsp;<span class="gallery-item-title">"<a target="_blank" href="https://conze.pt/explore/?l='+app.language+"&t=wikipedia-qid&s=true&i="+r+'">'+l+'</a>"</span><br/><span class="gallery-item-description">'+s+"</span></span></figcaption></figure>";$.each(e.results.bindings,(function(e,a){let t=a.photo.value.replace(/http:/,"https:")+"?width=300px",i=a.itemLabel.value||"",p="";void 0===typeof a.itemDescription||void 0===a.itemDescription||(p=a.itemDescription.value||"");let n=a.item.value.replace(/http:\/\/www.wikidata.org\/entity\//,"").split("-").shift();o+='<figure class="'+n+'"><img src="'+t+'" alt="-" width="300" height="100%"><figcaption><a href="javascript:void(0)" onclick="revealGalleryDetails(&quot;'+n+'&quot;)"><i class="fas fa-check-circle fa-3x"></i></a><span id="'+n+'" class="gallery-image-details incorrect" style="visibility:hidden;"></a>&nbsp;<span class="gallery-item-title">"<a target="_blank" href="https://conze.pt/explore/?l='+app.language+"&t=wikipedia-qid&s=true&i="+n+'">'+i+'</a>"</span><br/><span class="gallery-item-description">'+p+"</span></span></figcaption></figure>"})),$("span.gallery").html(o+c);let d=document.querySelector("span.gallery");for(var u=d.children.length;u>=0;u--)d.appendChild(d.children[Math.random()*u|0]);$("span.gallery").append("<br/><br/><br/><br/>"),$("#next-gallery-button").show()}))}))}function revealGalleryDetails(e){console.log(e),$("#"+e).hasClass("incorrect")?$("figure."+e+" i:first").css("color","red"):$("figure."+e).css("background","#237033"),$("#"+e).css("visibility","visible")}function listQuery(e){let a=10;"string"===app.pid_type&&(a=10);let t="";t=app.depth_query?`\n\n      SELECT ?item ?itemLabel ?itemDescription ?prop ?photo WHERE {\n       SELECT DISTINCT ?item ?itemLabel ?itemDescription ?prop ?photo ?linkTo {\n        SERVICE gas:service {\n          gas:program gas:gasClass "com.bigdata.rdf.graph.analytics.SSSP" ;\n          gas:in wd:${app.qid} ;\n          gas:traversalDirection "Reverse" ;\n          gas:out ?item ;\n          gas:maxIterations ${app.tree_depth};\n          gas:linkType wdt:${app.pid} .\n        }\n        ?item wdt:P18 ?photo\n\n        SERVICE wikibase:label {bd:serviceParam wikibase:language "${app.language},en" }\n       } ORDER BY STRUUID() ${app.random_spaces} LIMIT ${a}  \n      }\n\n    `:`\n      SELECT ?item ?itemLabel ?itemDescription ?prop ?photo WHERE { \n          { \n              SELECT ?item ?photo ?prop\n              WHERE { \n                  ?item wdt:P18 ?photo ;          \n                        wdt:${app.pid} ?prop ;\n                        ${e}\n              } ORDER BY STRUUID() ${app.random_spaces} LIMIT ${a}\n          } \n          SERVICE wikibase:label { bd:serviceParam wikibase:language "${app.language},en". } \n      } \n      `;const i="https://query.wikidata.org/bigdata/namespace/wdq/sparql?format=json&query="+t;console.log(t),console.log(encodeURI(i)),window.fetch(i).then((function(e){e.json().then((function(e){let a=Math.floor(Math.random()*e.results.bindings.length),t=e.results.bindings[a];loadImage(t.photo.value),window.locID=t.item.value,app.qid=t.item.value.replace(/http:\/\/www.wikidata.org\/entity\//,""),window.itemName=t.itemLabel.value,console.log(app.pid),app.pid;let i=[];window.itemPropsObj={};let o="";if(app.only_label?(app.pid_type="string",window.itemProp=t.itemLabel.value,$.each(e.results.bindings,(function(e,a){app.qid_=a.itemLabel.value,i.push(app.qid_),window.itemProps=Array.from(new Set(i))}))):(window.itemProp=t.prop.value.replace(/http:\/\/www.wikidata.org\/entity\//,"").split("-").shift(),$.each(e.results.bindings,(function(e,a){app.qid_=a.prop.value.replace(/http:\/\/www.wikidata.org\/entity\//,"").split("-").shift(),app.qid_.startsWith("Q")&&(i.push(app.qid_),window.itemProps=Array.from(new Set(i)))}))),t.itemDescription?window.itemDescription=t.itemDescription.value:window.itemDescription=void 0,"string"===app.pid_type)$.each(window.itemProps,(function(e,a){$("#myChoices").append($("<option>",{value:a,text:a}))})),$("#myChoices").append($("#myChoices option").remove().sort((function(e,a){let t=$(e).text().toLowerCase(),i=$(a).text().toLowerCase();return t>i?1:t<i?-1:0}))),$("#myTitle").html(app.pid_label+' <a id="learnmore" title="learn more about this topic" target="_blank" href="https://conze.pt/explore/'+app.qid_label+"?l="+app.language+"&t=wikipedia-qid&s=true&i="+app.qid+'"><i class="fab fa-leanpub"></i></a>'),$("#myChoices").prepend($("<option>",{value:"",text:"..."})),$("#myChoices").val("");else{$.each(window.itemProps,(function(e,a){o+=a+"|"})),o=o.slice(0,-1);let e="https://www.wikidata.org/w/api.php?action=wbgetentities&ids="+o+"&format=json&languages="+app.language+"|en&props=labels";console.log(e),$.ajax({url:e,jsonp:"callback",dataType:"jsonp",success:function(e){if(void 0===typeof e.entities||void 0===e.entities)return 1;Object.entries(e.entities).forEach(([e,a])=>{void 0===typeof a.labels.en||void 0===a.labels.en||(void 0===typeof a.labels[app.language]||void 0===a.labels[app.language]?window.itemPropsObj[e]=a.labels.en.value:window.itemPropsObj[e]=a.labels[app.language].value)}),Object.entries(window.itemPropsObj).forEach(([e,a])=>{$("#myChoices").append($("<option>",{value:e,text:a.toLowerCase()}))}),$("#myChoices").append($("#myChoices option").remove().sort((function(e,a){let t=$(e).text().toLowerCase(),i=$(a).text().toLowerCase();return t>i?1:t<i?-1:0}))),$("#myTitle").html(app.pid_label+' <a title="learn more about this topic" target="_blank" href="https://conze.pt/explore/'+app.qid_label+"?l="+app.language+"&t=wikipedia-qid&s=true&i="+app.qid+'"><i class="fab fa-leanpub"></i></a>'),$("#result").html('<div id="newmap"></div><h1><i class="fas fa-arrows-alt-h"></i> '+app.distance+'</strong>km</h1> <br/><h2><a target="_blank" href="https://conze.pt/explore/'+encodeURIComponent(window.itemName)+"?l="+app.language+"&t=wikipedia-qid&s=true&i="+window.qid+'">'+window.itemName+"</a>"+(window.itemDescription?", "+window.itemDescription:"")+'.</h2> <br/><button class="btn btn-info closeBtn submit" type="button"><i class="fas fa-long-arrow-alt-right"></i></button></p>'),$("#myChoices").prepend($("<option>",{value:"",text:"..."})),$("#myChoices").val("")}})}}))})).catch((function(e){console.warn("Fetch Error :-S",e)}))}function locationQuery(e){let a="",t="";""!==app.country&&(t=" wdt:P17 wd:"+app.country+" ; ",a=" ?place ");const i="https://query.wikidata.org/bigdata/namespace/wdq/sparql?format=json&query="+`\n    SELECT ?item ?itemLabel ?itemDescription ?lat ?lon ?photo ${a} WHERE { \n        { \n            SELECT ?item ?photo ?lat ?lon ${a}\n            WHERE { \n                ?item wdt:P18 ?photo ;\n                    p:${app.pid} ?statement ; \n                    ${t}\n                    ${e} \n                    ?statement psv:${app.pid} ?coords . \n                    ?coords wikibase:geoLatitude ?lat . \n                    ?coords wikibase:geoLongitude ?lon . \n            } ORDER BY STRUUID() ${app.random_spaces} LIMIT 50\n        } \n        SERVICE wikibase:label { bd:serviceParam wikibase:language "${app.language},en". } \n    } \n    `;window.fetch(i).then((function(e){200===e.status?e.json().then((function(e){let a=Math.floor(Math.random()*e.results.bindings.length),t=e.results.bindings[a];loadImage(t.photo.value),window.geocode={lat:t.lat.value,lon:t.lon.value},window.locID=t.item.value,window.qid=t.item.value.replace(/http:\/\/www.wikidata.org\/entity\//,""),window.itemName=t.itemLabel.value,t.itemDescription?window.itemDescription=t.itemDescription.value:window.itemDescription=void 0})):console.warn("Error: Status Code: "+e.status)})).catch((function(e){console.warn("Fetch Error :-S",e)}))}function loadImage(e){let a=e.replace(/http:/,"https:");a=a+"?width="+app.thumbnail_size+"px",$("<img/>").attr("src",a).on("load",(function(){$(this).remove(),$("body").css("background-image",'url("'+a+'")'),$("#loading").hide()}))}function stripHtml(e){if(void 0!==typeof e&&void 0!==e)return e.replace(/<\/?("[^"]*"|'[^']*'|[^>])*(>|$)/g,"")||""}function getParameterByName(e,a){a||(a=window.location.href);const t=new RegExp("[?&]"+e+"(=([^&#]*)|&|#|$)").exec(a);return t&&t[2]?stripHtml(decodeURIComponent(t[2].replace(/\+/g," "))):""}function mapInitialize(){app.mymap=L.map("map"),app.mymap.setView([30,10],1),L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'© <a href="https://openstreetmap.org">OpenStreetMap</a> contributors',maxZoom:18}).addTo(app.mymap),app.guess=L.marker([-999,-999]).addTo(app.mymap),app.guess.setLatLng({lat:-999,lng:-999}),app.mymap.on("click",(function(e){app.guess.setLatLng(e.latlng),window.geocode_guess=e.latlng})),app.mymap.addControl(new L.Control.Fullscreen)}function selectInitialize(){$("#map").html('<label id="myTitle" for="myChoices"></label><select name="myChoices" id="myChoices"></select>')}function galleryInitialize(){$("#panel, .global-actions").css("display","none"),console.log("todo: initialize gallery")}function newInput(){if("location"===app.mode){let e=L.map("newmap").setView([30,10],1);L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'© <a href="https://openstreetmap.org">OpenStreetMap</a> contributors',maxZoom:18}).addTo(e);let a=L.icon({iconUrl:"img/guess.png",iconAnchor:[25,41]}),t=L.icon({iconUrl:"img/actual.png",iconAnchor:[25,41]}),i=L.marker([0,0],{icon:a}).addTo(e),o=L.marker([0,0],{icon:t}).addTo(e);i.setLatLng(window.geocode_guess),o.setLatLng(window.geocode),e.fitBounds(L.latLngBounds(i.getLatLng(),o.getLatLng()),{padding:[50,50]}),e.addControl(new L.Control.Fullscreen)}else"list"===app.mode?$("#map").html('<label id="myTitle" for="myChoices"></label><select name="myChoices" id="myChoices"></select>'):"gallery"===app.mode&&console.log("todo: gallery reset")}function calculateDistance(e,a,t,i){let o=toRadians(t-e),p=toRadians(i-a);e=toRadians(e),t=toRadians(t);let n=Math.sin(o/2)*Math.sin(o/2)+Math.sin(p/2)*Math.sin(p/2)*Math.cos(e)*Math.cos(t);return 6371*(2*Math.atan2(Math.sqrt(n),Math.sqrt(1-n)))}function toRadians(e){return e*Math.PI/180}function doGuess(){if("list"===app.mode){$("#myChoices").val()===window.itemProp?app.correct_answer=!0:app.correct_answer=!1}else if("gallery"===app.mode)console.log("todo: check gallery answer");else if("location"===app.mode){app.distance=Math.ceil(calculateDistance(window.geocode.lat,window.geocode.lon,window.geocode_guess.lat,window.geocode_guess.lng));let e=40075;app.distance}endRound()}function endRound(){if("location"===app.mode)$("#result").html('<div id="newmap"></div><h1><i class="fas fa-arrows-alt-h"></i> '+app.distance+'</strong>km</h1> <br/><h2><a id="learnmore" target="_blank" href="https://conze.pt/explore/'+encodeURIComponent(window.itemName)+"?l="+app.language+"&t=wikipedia-qid&s=true&i="+window.qid+'">'+window.itemName+"</a>"+(window.itemDescription?", "+window.itemDescription:"")+'.</h2> <br/><button class="btn btn-info closeBtn submit" type="button"><i class="fas fa-long-arrow-alt-right"></i></button></p>');else if("gallery"===app.mode)console.log("todo: reset gallery endRound");else if("list"===app.mode){let e="";"string"===app.pid_type?(e=app.correct_answer?'<i class="far fa-check-circle fa-3x" style="color: green;"></i> <br/> <a target="_blank" href="https://conze.pt/explore/'+encodeURIComponent(window.itemProp)+"?l="+app.language+'&t=wikipedia&s=true&">'+window.itemProp+"</a>":'<i class="far fa-times-circle fa-3x" style="color: red;"></i> <br/> <a target="_blank" href="https://conze.pt/explore/'+encodeURIComponent(window.itemProp)+"?l="+app.language+'&t=wikipedia&s=true">'+window.itemProp+"</a>",$("#result").html("<h2>"+e+"</h2> <h2>"+(window.itemDescription?window.itemDescription:"")+'</h2><br/><button class="btn btn-info closeBtn submit" type="button"><i class="fas fa-long-arrow-alt-right"></i></button>')):(e=app.correct_answer?'<i class="far fa-check-circle fa-3x" style="color: green;"></i> <br/> <a target="_blank" href="https://conze.pt/explore/'+encodeURIComponent(window.itemPropsObj[window.itemProp])+"?l="+app.language+"&t=wikipedia-qid&s=true&i="+window.itemProp+'">'+window.itemPropsObj[window.itemProp]+"</a>":'<i class="far fa-times-circle fa-3x" style="color: red;"></i> <br/> <a target="_blank" href="https://conze.pt/explore/'+encodeURIComponent(window.itemPropsObj[window.itemProp])+"?l="+app.language+"&t=wikipedia-qid&s=true&i="+window.itemProp+'">'+window.itemPropsObj[window.itemProp]+"</a>",$("#result").html("<h2>"+e+'</h2> <br/><h2><a target="_blank" href="https://conze.pt/explore/'+encodeURIComponent(window.itemName)+"?l="+app.language+"&t=wikipedia-qid&s=true&i="+window.qid+'">'+window.itemName+"</a>"+(window.itemDescription?", "+window.itemDescription:"")+'.</h2><br/><button class="btn btn-info closeBtn submit" type="button"><i class="fas fa-long-arrow-alt-right"></i></button>'))}$("#result").fadeIn()}$(document).ready((function(){init()})),document.toggleFullscreen=function(){return screenfull.enabled&&screenfull.toggle(),0};
